# üçÖ Pomodoro –¢–∞–π–º–µ—Ä - –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

## –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç Pomodoro —Ç–∞–π–º–µ—Ä

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

Pomodoro —Ç–∞–π–º–µ—Ä —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ –¥–≤—É—Ö —á–∞—Å—Ç–µ–π:

1. **`PomodoroManager`** (`bot/src/pomodoro.js`) - —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –ø–∞–º—è—Ç–∏
   - –£–ø—Ä–∞–≤–ª—è–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–º–∏ —Ç–∞–π–º–µ—Ä–∞–º–∏
   - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å–º–µ–Ω–µ —Ñ–∞–∑
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `setTimeout` –¥–ª—è —Ç–∞–π–º–µ—Ä–æ–≤

2. **`PomodoroRepository`** (`src/database/repositories/pomodoroRepository.js`) - —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –ë–î
   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–µ—Å—Å–∏–∏ –≤ PostgreSQL
   - –ü–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—É—á–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É

### –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—É—Å–∫–∞–µ—Ç Pomodoro
   ‚Üì
2. PomodoroManager.start() —Å–æ–∑–¥–∞–µ—Ç —Å–µ—Å—Å–∏—é –≤ –ø–∞–º—è—Ç–∏
   ‚Üì
3. –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ü–∏–∫–ª: –†–∞–±–æ—Ç–∞ ‚Üí –ü–µ—Ä–µ—Ä—ã–≤ ‚Üí –†–∞–±–æ—Ç–∞ ‚Üí ...
   ‚Üì
4. –ü—Ä–∏ –∫–∞–∂–¥–æ–º –ø–µ—Ä–µ—Ö–æ–¥–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
   ‚Üì
5. –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö —Ü–∏–∫–ª–æ–≤ —Å–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è
```

### –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

**–í –ø–∞–º—è—Ç–∏ (PomodoroManager):**
- –ê–∫—Ç–∏–≤–Ω—ã–µ —Ç–∞–π–º–µ—Ä—ã
- –¢–µ–∫—É—â–∏–µ —Å–µ—Å—Å–∏–∏
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å–º–µ–Ω–µ —Ñ–∞–∑

**–í –ë–î (PomodoroRepository):**
- –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏
- –ò—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö —Å–µ—Å—Å–∏–π
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

### –ü—Ä–æ–±–ª–µ–º–∞ —Ç–µ–∫—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

–°–µ–π—á–∞—Å —Å–µ—Å—Å–∏–∏ **–Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ë–î –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏**. –û–Ω–∏ —Ç–æ–ª—å–∫–æ –≤ –ø–∞–º—è—Ç–∏, –∏ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞ —Ç–µ—Ä—è—é—Ç—Å—è.

## üìä –ö–∞–∫–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–∞

### –ë–∞–∑–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏

1. **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–µ—Å—Å–∏–π** - —Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—É—Å–∫–∞–ª Pomodoro
2. **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ü–∏–∫–ª–æ–≤** - –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞–±–æ—á–∏—Ö —Ü–∏–∫–ª–æ–≤
3. **–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã** - –æ–±—â–µ–µ –≤—Ä–µ–º—è –≤ –º–∏–Ω—É—Ç–∞—Ö/—á–∞—Å–∞—Ö
4. **–í—Ä–µ–º—è –ø–µ—Ä–µ—Ä—ã–≤–æ–≤** - –æ–±—â–µ–µ –≤—Ä–µ–º—è –ø–µ—Ä–µ—Ä—ã–≤–æ–≤

### –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏

1. **–°—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ü–∏–∫–ª–æ–≤ –Ω–∞ —Å–µ—Å—Å–∏—é**
2. **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –¥–µ–Ω—å/–Ω–µ–¥–µ–ª—é/–º–µ—Å—è—Ü**
3. **–°–∞–º–∞—è –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–∞—è –∑–∞–¥–∞—á–∞** (–µ—Å–ª–∏ –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ –∑–∞–¥–∞—á–µ)
4. **–ì—Ä–∞—Ñ–∏–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏** (–ø–æ –¥–Ω—è–º/–Ω–µ–¥–µ–ª—è–º)

## üîß –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

### –ú–µ—Ç–æ–¥—ã –≤ PomodoroRepository

```javascript
// –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ —Å–µ–≥–æ–¥–Ω—è
await pomodoroRepo.getTodayStats(userId);

// –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –Ω–µ–¥–µ–ª—é
await pomodoroRepo.getWeekStats(userId);

// –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –º–µ—Å—è—Ü
await pomodoroRepo.getMonthStats(userId);

// –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
await pomodoroRepo.getTotalStats(userId);
```

### –ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞

```javascript
{
  totalSessions: 15,           // –í—Å–µ–≥–æ —Å–µ—Å—Å–∏–π
  totalCycles: 60,             // –í—Å–µ–≥–æ —Ü–∏–∫–ª–æ–≤
  totalWorkMinutes: 1500,      // –í—Å–µ–≥–æ –º–∏–Ω—É—Ç —Ä–∞–±–æ—Ç—ã
  totalBreakMinutes: 300,      // –í—Å–µ–≥–æ –º–∏–Ω—É—Ç –ø–µ—Ä–µ—Ä—ã–≤–æ–≤
  totalHours: 25.0,            // –í—Å–µ–≥–æ —á–∞—Å–æ–≤ —Ä–∞–±–æ—Ç—ã
  averageCyclesPerSession: 4.0 // –°—Ä–µ–¥–Ω–µ–µ —Ü–∏–∫–ª–æ–≤ –Ω–∞ —Å–µ—Å—Å–∏—é
}
```

## üöÄ –ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ—Å—Å–∏–π –≤ –ë–î

### –í–∞—Ä–∏–∞–Ω—Ç 1: –°–æ—Ö—Ä–∞–Ω—è—Ç—å –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏

–í `PomodoroManager.finishCycle()`:

```javascript
finishCycle(session) {
  session.currentCycle += 1;

  if (session.currentCycle > session.cycles) {
    // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ë–î
    await store.completePomodoroSession(session.dbId);
    
    session.ctx.reply('‚úÖ –ü–æ–º–æ–¥–æ—Ä–æ –∑–∞–≤–µ—Ä—à—ë–Ω! –û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞.');
    this.stop(session.userId, false);
    return;
  }

  this.runWorkPhase(session);
}
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –°–æ—Ö—Ä–∞–Ω—è—Ç—å –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ

–í `PomodoroManager.start()`:

```javascript
async start(userId, ctx, task, config) {
  this.stop(userId, false);

  // –°–æ–∑–¥–∞—Ç—å —Å–µ—Å—Å–∏—é –≤ –ë–î
  const dbSession = await store.createPomodoroSession(userId, {
    taskId: task?._dbId || null,
    workMinutes: config.workMinutes || 25,
    breakMinutes: config.breakMinutes || 5,
    cycles: config.cycles || 4,
  });

  const session = {
    userId,
    task,
    ctx,
    dbId: dbSession.id, // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å ID –∏–∑ –ë–î
    workMinutes: config.workMinutes || 25,
    breakMinutes: config.breakMinutes || 5,
    cycles: config.cycles || 4,
    currentCycle: 1,
    timers: [],
  };

  this.sessions.set(userId, session);
  this.runWorkPhase(session);
}
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: –û–±–Ω–æ–≤–ª—è—Ç—å –ø—Ä–∏ –∫–∞–∂–¥–æ–º —Ü–∏–∫–ª–µ

–û–±–Ω–æ–≤–ª—è—Ç—å `currentCycle` –≤ –ë–î –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Ü–∏–∫–ª–∞.

## üìà –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

### –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É `/stats`

```javascript
bot.command('stats', async (ctx) => {
  const userId = getUserId(ctx);
  const stats = await store.getPomodoroStats(userId);
  
  const message = `
üçÖ *–í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ Pomodoro*

üìä –í—Å–µ–≥–æ —Å–µ—Å—Å–∏–π: ${stats.totalSessions}
üîÑ –í—Å–µ–≥–æ —Ü–∏–∫–ª–æ–≤: ${stats.totalCycles}
‚è± –í—Å–µ–≥–æ —á–∞—Å–æ–≤ —Ä–∞–±–æ—Ç—ã: ${stats.totalHours}
üìà –°—Ä–µ–¥–Ω–µ–µ —Ü–∏–∫–ª–æ–≤ –Ω–∞ —Å–µ—Å—Å–∏—é: ${stats.averageCyclesPerSession}

–°–µ–≥–æ–¥–Ω—è:
üìä –°–µ—Å—Å–∏–π: ${stats.today.totalSessions}
üîÑ –¶–∏–∫–ª–æ–≤: ${stats.today.totalCycles}
‚è± –ú–∏–Ω—É—Ç —Ä–∞–±–æ—Ç—ã: ${stats.today.totalWorkMinutes}
  `;
  
  await ctx.reply(message, { format: 'markdown' });
});
```

## üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–°–æ—Ö—Ä–∞–Ω—è—Ç—å —Å–µ—Å—Å–∏–∏ –≤ –ë–î** –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –∏–ª–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
2. **–û–±–Ω–æ–≤–ª—è—Ç—å currentCycle** –ø—Ä–∏ –∫–∞–∂–¥–æ–º —Ü–∏–∫–ª–µ (–¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞)
3. **–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É `/stats`** –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
4. **–î–æ–±–∞–≤–∏—Ç—å –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç** –≤ –¥–∞–π–¥–∂–µ—Å—Ç

