# ⏰ Настройка времени дайджеста

## Как это работает

Пользователь может настроить время, когда он хочет получать ежедневный дайджест событий.

### В БД

Добавлено поле `dailyDigestTime` в таблицу `user_settings`:
- Тип: `String`
- Формат: `"HH:mm"` (например, `"09:00"`, `"18:30"`)
- По умолчанию: `"09:00"`

### В настройках бота

1. Пользователь открывает настройки: `/menu` → ⚙️ Настройки
2. Нажимает кнопку "⏰ Изменить время дайджеста"
3. Вводит время в формате `ЧЧ:ММ` (например, `09:00` или `18:30`)
4. Бот проверяет формат и сохраняет настройку
5. Дайджест будет отправляться в указанное время

### Валидация

Бот проверяет формат времени:
- Должно быть `ЧЧ:ММ`
- Часы: 00-23
- Минуты: 00-59

Примеры валидных значений:
- `09:00` ✅
- `18:30` ✅
- `00:00` ✅
- `23:59` ✅

Примеры невалидных:
- `9:00` ❌ (нужно `09:00`)
- `25:00` ❌ (часы > 23)
- `09:60` ❌ (минуты > 59)
- `9:0` ❌ (неправильный формат)

## Реализация

### Схема БД

```prisma
model UserSettings {
  dailyDigestTime String @default("09:00") @map("daily_digest_time")
  // ...
}
```

### Планирование

В `notifications.js`:

```javascript
// Парсим время из формата "HH:mm"
const [hours, minutes] = (settings.dailyDigestTime || '09:00').split(':').map(Number);

// Создаем cron правило: "минуты часы * * *"
const cronRule = `${minutes} ${hours} * * *`;

schedule.scheduleJob(
  { rule: cronRule, tz: settings.timezone },
  async () => await this.sendDailySummary(userId)
);
```

### Обработка в боте

1. Кнопка в настройках: `settings:digest_time`
2. Диалог для ввода времени
3. Валидация формата
4. Сохранение в БД
5. Перепланирование задачи

## Использование

### Пользователь

1. Открыть настройки
2. Нажать "⏰ Изменить время дайджеста"
3. Ввести время (например, `08:00`)
4. Готово! Дайджест будет приходить в 08:00

### Программно

```javascript
// Получить текущее время
const settings = await store.getSettings(userId);
console.log(settings.dailyDigestTime); // "09:00"

// Изменить время
await store.updateSettings(userId, { dailyDigestTime: '08:00' });

// Перепланировать задачу
await notifications.ensureDailyJob(userId);
```

## Важные детали

1. **Часовой пояс**: Время учитывается в часовом поясе пользователя (`settings.timezone`)
2. **Перепланирование**: При изменении времени задача автоматически перепланируется
3. **Формат**: Всегда используется формат `HH:mm` (двузначные часы и минуты)
4. **Валидация**: Бот проверяет корректность формата перед сохранением

## Примеры

### Установить время на 08:00

```
Пользователь: /menu → ⚙️ Настройки → ⏰ Изменить время дайджеста
Бот: Введите время отправки дайджеста в формате ЧЧ:ММ...
Пользователь: 08:00
Бот: ✅ Время дайджеста обновлено: 08:00
```

### Установить время на 18:30

```
Пользователь: /menu → ⚙️ Настройки → ⏰ Изменить время дайджеста
Бот: Введите время отправки дайджеста в формате ЧЧ:ММ...
Пользователь: 18:30
Бот: ✅ Время дайджеста обновлено: 18:30
```

## Миграция

После добавления поля нужно создать миграцию:

```bash
npm run migrate
```

Или если используете Docker:

```bash
docker compose exec bot npx prisma migrate dev
```

